{% extends "base.html" %}

{% block content %}
<div class="p-8 bg-gray-50 min-h-screen">

    <!-- Header -->
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold text-gray-800">Provider Schedule</h1>
        <button onclick="openBookingModal()"
            class="bg-teal-700 hover:bg-teal-800 text-white font-bold py-2 px-4 rounded shadow flex items-center">
            <span class="mr-2">+</span> New Appointment
        </button>
    </div>

    <!-- Filters (White Box Style) -->
    <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-100 mb-6">
        <div class="flex items-center space-x-8">
            <div class="w-1/4">
                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Provider</label>
                <select id="staffSelect" onchange="loadAppointments()"
                    class="block w-full border border-gray-300 rounded px-3 py-2 text-gray-700 bg-white focus:outline-none focus:ring-1 focus:ring-blue-500">
                    {% for s in staff %}
                    <option value="{{ s.id }}">{{ s.username }} ({{ s.role }})</option>
                    {% endfor %}
                </select>
            </div>
            <div class="w-1/4">
                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Date</label>
                <input type="date" id="dateSelect" onchange="loadAppointments()" value="{{ today }}"
                    class="block w-full border border-gray-300 rounded px-3 py-2 text-gray-700 focus:outline-none focus:ring-1 focus:ring-blue-500">
            </div>

            <!-- View Mode Toggle -->
            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">View</label>
                <div class="flex rounded-lg border border-gray-300 overflow-hidden">
                    <button id="viewDay" onclick="setViewMode('day')"
                        class="px-4 py-2 text-sm font-medium bg-teal-600 text-white">Day</button>
                    <button id="viewWeek" onclick="setViewMode('week')"
                        class="px-4 py-2 text-sm font-medium bg-white text-gray-700 hover:bg-gray-50">Week</button>
                </div>
            </div>

            <div class="flex-grow flex justify-end items-center text-gray-500 font-medium">
                <!-- Date navigator - Now functional -->
                <button onclick="changeDate(-1)" class="p-2 hover:bg-gray-100 rounded text-xl font-bold">&lt;</button>
                <span class="mx-3 cursor-pointer hover:text-teal-600 flex items-center gap-2"
                    onclick="document.getElementById('dateSelect').showPicker()">
                    <span id="displayDate">Dec 1, 2025</span>
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z">
                        </path>
                    </svg>
                </span>
                <button onclick="changeDate(1)" class="p-2 hover:bg-gray-100 rounded text-xl font-bold">&gt;</button>
            </div>
        </div>

        <!-- Visit Type Legend -->
        <div class="flex items-center gap-4 mt-4 pt-4 border-t border-gray-100">
            <span class="text-xs font-bold text-gray-400 uppercase">Visit Types:</span>
            <span class="flex items-center gap-1.5"><span class="w-3 h-3 rounded-full bg-blue-500"></span><span
                    class="text-xs text-gray-600">General Checkup</span></span>
            <span class="flex items-center gap-1.5"><span class="w-3 h-3 rounded-full bg-purple-500"></span><span
                    class="text-xs text-gray-600">Consult</span></span>
            <span class="flex items-center gap-1.5"><span class="w-3 h-3 rounded-full bg-teal-500"></span><span
                    class="text-xs text-gray-600">Follow-up</span></span>
            <span class="flex items-center gap-1.5"><span class="w-3 h-3 rounded-full bg-orange-500"></span><span
                    class="text-xs text-gray-600">Lab Work</span></span>
        </div>
    </div>

    <!-- Schedule Grid (Day View) -->
    <div id="dayView" class="bg-white rounded-lg shadow-sm border border-gray-100 divide-y divide-gray-100"
        id="scheduleGrid">
        <!-- Javascript renders slots here -->
    </div>

    <!-- Week View Grid (hidden by default) -->
    <div id="weekView" class="hidden bg-white rounded-lg shadow-sm border border-gray-100 overflow-hidden">
        <div id="weekGrid">
            <!-- Javascript renders week here -->
        </div>
    </div>
</div>

<!-- Booking Modal -->
<div id="bookingModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-40">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <h3 class="text-lg font-bold text-gray-900 mb-4">New Appointment</h3>

        <!-- Red Alert -->
        <div id="conflictAlert" class="hidden bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-4" role="alert">
            <p><strong>Conflict!</strong> <span id="conflictMsg">Time slot unavailable.</span></p>
        </div>

        <form id="bookingForm">
            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2">Patient</label>
                <select id="patientSelect" class="border rounded w-full py-2 px-3 text-gray-700">
                    <!-- Populated via API -->
                </select>
            </div>
            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2">Visit Type</label>
                <select id="visitType" class="border rounded w-full py-2 px-3 text-gray-700">
                    <option value="General Checkup">General Checkup</option>
                    <option value="Consult">Consult</option>
                    <option value="Follow-up">Follow-up</option>
                    <option value="Lab Work">Lab Work</option>
                </select>
            </div>
            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2">Time</label>
                <select id="timeSlot" class="border rounded w-full py-2 px-3 text-gray-700">
                    <!-- 9-5 slots -->
                    <option value="09:00">09:00 AM</option>
                    <option value="10:00">10:00 AM</option>
                    <option value="11:00">11:00 AM</option>
                    <!-- Skip 12 for lunch -->
                    <option value="13:00">01:00 PM</option>
                    <option value="14:00">02:00 PM</option>
                    <option value="15:00">03:00 PM</option>
                    <option value="16:00">04:00 PM</option>
                    <option value="17:00">05:00 PM</option>
                </select>
            </div>
            <div class="flex justify-end gap-2">
                <button type="button" onclick="closeBookingModal()"
                    class="bg-gray-500 text-white px-4 py-2 rounded">Cancel</button>
                <button type="submit" class="bg-teal-700 text-white px-4 py-2 rounded">Book</button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Appointment Modal (Updated) -->
<div id="editModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-0 border w-[500px] shadow-2xl rounded-lg bg-white overflow-hidden">
        <!-- Header -->
        <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center">
            <h3 class="text-xl font-bold text-gray-800">Edit Appointment</h3>
            <button onclick="closeEditModal()"
                class="text-gray-400 hover:text-gray-600 font-bold text-xl">&times;</button>
        </div>

        <div class="p-6">
            <!-- Appointment Info -->
            <div class="flex justify-between items-start mb-6">
                <div>
                    <h4 class="text-lg font-bold text-gray-900" id="editPatientName">Patient Name</h4>
                    <p class="text-sm text-gray-500" id="editVisitType">Visit Type</p>
                </div>
                <div class="text-right text-gray-600 text-sm">
                    <p id="editDate">Nov 3, 2025</p>
                    <p id="editTime">11:00 AM</p>
                </div>
            </div>

            <form id="editForm">
                <input type="hidden" id="editApptId">

                <div class="mb-6">
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Appointment Status</label>
                    <select id="editStatus" onchange="toggleReasonBox()"
                        class="block w-full border-2 border-yellow-400 rounded-md px-4 py-3 text-gray-900 font-bold focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="Scheduled">Scheduled</option>
                        <option value="Completed">Completed</option>
                        <option value="Canceled">Canceled</option>
                    </select>
                </div>

                <!-- Reason Box (Conditional Red) -->
                <div id="reasonContainer" class="hidden mb-6">
                    <label class="block text-xs font-bold text-red-600 uppercase mb-2">Reason for Cancellation *</label>
                    <textarea id="editReason" rows="3"
                        class="block w-full border border-red-200 bg-red-50 rounded-md px-4 py-3 text-gray-900 focus:outline-none focus:border-red-500"
                        placeholder="e.g. Patient requested reschedule"></textarea>
                </div>

                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" onclick="closeEditModal()"
                        class="text-gray-600 font-bold px-4 py-2 hover:text-gray-800">Cancel</button>
                    <button type="submit"
                        class="bg-teal-800 hover:bg-teal-900 text-white font-bold px-6 py-2 rounded-md">Update
                        Status</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // View mode state
    let currentViewMode = 'day';

    // Visit type color scheme
    function getVisitTypeColors(visitType) {
        const colors = {
            'General Checkup': { bg: 'bg-blue-50', border: 'border-blue-500', text: 'text-blue-900', badge: 'bg-blue-500' },
            'Consult': { bg: 'bg-purple-50', border: 'border-purple-500', text: 'text-purple-900', badge: 'bg-purple-500' },
            'Follow-up': { bg: 'bg-teal-50', border: 'border-teal-500', text: 'text-teal-900', badge: 'bg-teal-500' },
            'Lab Work': { bg: 'bg-orange-50', border: 'border-orange-500', text: 'text-orange-900', badge: 'bg-orange-500' }
        };
        return colors[visitType] || colors['General Checkup'];
    }

    // Toggle view mode
    function setViewMode(mode) {
        currentViewMode = mode;

        // Update button styles
        const dayBtn = document.getElementById('viewDay');
        const weekBtn = document.getElementById('viewWeek');

        if (mode === 'day') {
            dayBtn.className = 'px-4 py-2 text-sm font-medium bg-teal-600 text-white';
            weekBtn.className = 'px-4 py-2 text-sm font-medium bg-white text-gray-700 hover:bg-gray-50';
            document.getElementById('dayView').classList.remove('hidden');
            document.getElementById('weekView').classList.add('hidden');
        } else {
            weekBtn.className = 'px-4 py-2 text-sm font-medium bg-teal-600 text-white';
            dayBtn.className = 'px-4 py-2 text-sm font-medium bg-white text-gray-700 hover:bg-gray-50';
            document.getElementById('dayView').classList.add('hidden');
            document.getElementById('weekView').classList.remove('hidden');
        }

        loadAppointments();
    }

    // Format date string without timezone issues
    function formatDateDisplay(dateStr) {
        const [year, month, day] = dateStr.split('-').map(Number);
        const d = new Date(year, month - 1, day);
        return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }

    // Change date by delta days (-1 for previous, +1 for next)
    function changeDate(delta) {
        const dateInput = document.getElementById('dateSelect');
        const [year, month, day] = dateInput.value.split('-').map(Number);
        const currentDate = new Date(year, month - 1, day);
        currentDate.setDate(currentDate.getDate() + delta);

        // Format back to YYYY-MM-DD
        const newYear = currentDate.getFullYear();
        const newMonth = String(currentDate.getMonth() + 1).padStart(2, '0');
        const newDay = String(currentDate.getDate()).padStart(2, '0');
        dateInput.value = `${newYear}-${newMonth}-${newDay}`;

        // Update display and reload
        document.getElementById('displayDate').textContent = formatDateDisplay(dateInput.value);
        loadAppointments();
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadPatients();
        loadAppointments();

        // Initial date display
        const dateInput = document.getElementById('dateSelect');
        const displaySpan = document.getElementById('displayDate');
        displaySpan.textContent = formatDateDisplay(dateInput.value);

        dateInput.addEventListener('change', (e) => {
            displaySpan.textContent = formatDateDisplay(e.target.value);
        });
    });

    async function loadPatients() {
        const response = await fetch('/patients/api/search');
        const patients = await response.json();
        const select = document.getElementById('patientSelect');
        patients.forEach(p => {
            const opt = document.createElement('option');
            opt.value = p.id;
            opt.textContent = `${p.name} (CH-${p.chart_number})`;
            select.appendChild(opt);
        });
    }

    async function loadAppointments() {
        const staffId = document.getElementById('staffSelect').value;
        const date = document.getElementById('dateSelect').value;

        if (currentViewMode === 'day') {
            const response = await fetch(`/appointments/api/list?staff_id=${staffId}&date=${date}`);
            const appointments = await response.json();
            renderDayGrid(appointments);
        } else {
            // Week view - fetch appointments for the whole week
            await renderWeekView(staffId, date);
        }
    }

    function renderDayGrid(appointments) {
        const grid = document.getElementById('dayView');
        grid.innerHTML = '';

        const times = ['09:00', '10:00', '11:00', '12:00', '13:00', '14:00', '15:00', '16:00', '17:00'];

        times.forEach(time => {
            const row = document.createElement('div');
            row.className = 'flex min-h-[100px] hover:bg-gray-50/50 transition';

            // Time Column
            const timeCol = document.createElement('div');
            timeCol.className = 'w-24 p-4 border-r border-gray-100 text-xs font-bold text-gray-400 uppercase pt-6';

            // Format time AM/PM
            const [h, m] = time.split(':');
            const d = new Date(); d.setHours(h); d.setMinutes(m);
            const timeStr = d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            timeCol.textContent = timeStr;

            row.appendChild(timeCol);

            // Content Column
            const contentCol = document.createElement('div');
            contentCol.className = 'flex-grow p-2 relative';

            // Lunch Break Logic (12:00)
            if (time === '12:00') {
                contentCol.innerHTML = `
                    <div class="h-full w-full bg-gray-50 rounded border border-dashed border-gray-200 flex items-center justify-center text-sm font-bold text-gray-400">
                        Lunch Break
                    </div>
                `;
            } else {
                // Find appointment
                const appt = appointments.find(a => a.time === time);

                if (appt) {
                    const colors = getVisitTypeColors(appt.visit_type);

                    if (appt.status === 'Canceled') {
                        contentCol.innerHTML = `
                            <div class="h-full w-full bg-red-50 border border-red-100 rounded p-4 cursor-pointer opacity-75" onclick="openEditModal(${JSON.stringify(appt).replace(/"/g, '&quot;')})">
                                <p class="font-bold text-red-900 line-through">${appt.patient_name}</p>
                                <p class="text-xs text-red-700">Canceled: ${appt.reason || 'No reason'}</p>
                            </div>
                        `;
                    } else if (appt.status === 'Completed') {
                        contentCol.innerHTML = `
                            <div class="h-full w-full bg-green-50 border border-green-100 rounded p-4 cursor-pointer" onclick="openEditModal(${JSON.stringify(appt).replace(/"/g, '&quot;')})">
                                <p class="font-bold text-green-900">${appt.patient_name} âœ“</p>
                                <p class="text-xs text-green-700">${appt.visit_type}</p>
                            </div>
                        `;
                    } else {
                        // Scheduled - Color coded by visit type
                        contentCol.innerHTML = `
                            <div class="h-full w-full ${colors.bg} border-l-4 ${colors.border} rounded-r p-3 cursor-pointer hover:shadow-md transition" onclick="openEditModal(${JSON.stringify(appt).replace(/"/g, '&quot;')})">
                                <div class="flex justify-between">
                                    <p class="font-bold ${colors.text}">${appt.patient_name}</p>
                                    <span class="${colors.badge} text-white text-[10px] font-bold px-2 py-0.5 rounded-full">${appt.visit_type}</span>
                                </div>
                                <p class="text-xs ${colors.text} opacity-75 mt-1">ðŸ•’ ${timeStr}</p>
                            </div>
                        `;
                    }
                }
            }

            row.appendChild(contentCol);
            grid.appendChild(row);
        });
    }

    async function renderWeekView(staffId, dateStr) {
        const weekGrid = document.getElementById('weekGrid');
        weekGrid.innerHTML = '';

        // Parse the date
        const [year, month, day] = dateStr.split('-').map(Number);
        const baseDate = new Date(year, month - 1, day);

        // Get start of week (Sunday)
        const startOfWeek = new Date(baseDate);
        startOfWeek.setDate(baseDate.getDate() - baseDate.getDay());

        // Days of the week
        const days = [];
        for (let i = 0; i < 7; i++) {
            const d = new Date(startOfWeek);
            d.setDate(startOfWeek.getDate() + i);
            days.push(d);
        }

        // Build header row
        const headerRow = document.createElement('div');
        headerRow.className = 'grid grid-cols-8 border-b border-gray-200';

        // Empty cell for time column
        headerRow.innerHTML = '<div class="p-3 bg-gray-50 border-r border-gray-200"></div>';

        days.forEach(d => {
            const isToday = d.toDateString() === new Date().toDateString();
            const cell = document.createElement('div');
            cell.className = `p-3 text-center border-r border-gray-200 ${isToday ? 'bg-teal-50' : 'bg-gray-50'}`;
            cell.innerHTML = `
                <div class="text-xs font-bold uppercase ${isToday ? 'text-teal-600' : 'text-gray-500'}">${d.toLocaleDateString('en-US', { weekday: 'short' })}</div>
                <div class="text-lg font-bold ${isToday ? 'text-teal-700' : 'text-gray-700'}">${d.getDate()}</div>
            `;
            headerRow.appendChild(cell);
        });
        weekGrid.appendChild(headerRow);

        // Fetch appointments for each day
        const weekAppointments = {};
        for (const d of days) {
            const dateKey = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
            const response = await fetch(`/appointments/api/list?staff_id=${staffId}&date=${dateKey}`);
            weekAppointments[dateKey] = await response.json();
        }

        // Time slots
        const times = ['09:00', '10:00', '11:00', '12:00', '13:00', '14:00', '15:00', '16:00', '17:00'];

        times.forEach(time => {
            const row = document.createElement('div');
            row.className = 'grid grid-cols-8 border-b border-gray-100 min-h-[60px]';

            // Time cell
            const [h, m] = time.split(':');
            const timeD = new Date(); timeD.setHours(h); timeD.setMinutes(m);
            const timeStr = timeD.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });

            row.innerHTML = `<div class="p-2 border-r border-gray-100 text-xs font-bold text-gray-400 flex items-center justify-center">${timeStr}</div>`;

            days.forEach(d => {
                const dateKey = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
                const dayAppts = weekAppointments[dateKey] || [];
                const appt = dayAppts.find(a => a.time === time);

                const cell = document.createElement('div');
                cell.className = 'p-1 border-r border-gray-100';

                if (time === '12:00') {
                    cell.innerHTML = '<div class="h-full w-full bg-gray-50 rounded text-xs text-gray-400 flex items-center justify-center">Lunch</div>';
                } else if (appt) {
                    const colors = getVisitTypeColors(appt.visit_type);
                    cell.innerHTML = `
                        <div class="${colors.bg} ${colors.border} border-l-2 rounded-r p-1 h-full cursor-pointer text-xs" 
                             onclick="openEditModal(${JSON.stringify(appt).replace(/"/g, '&quot;')})">
                            <div class="font-bold ${colors.text} truncate">${appt.patient_name}</div>
                        </div>
                    `;
                }

                row.appendChild(cell);
            });

            weekGrid.appendChild(row);
        });
    }

    // Modal Logic
    function openBookingModal() {
        document.getElementById('bookingModal').classList.remove('hidden');
        document.getElementById('conflictAlert').classList.add('hidden');
    }

    function closeBookingModal() {
        document.getElementById('bookingModal').classList.add('hidden');
    }

    document.getElementById('bookingForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const data = {
            staff_id: document.getElementById('staffSelect').value,
            patient_id: document.getElementById('patientSelect').value,
            visit_type: document.getElementById('visitType').value,
            date: document.getElementById('dateSelect').value,
            time: document.getElementById('timeSlot').value
        };

        const response = await fetch('/appointments/create', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        if (response.ok) {
            closeBookingModal();
            loadAppointments();
        } else if (response.status === 409) {
            const conflict = document.getElementById('conflictAlert');
            conflict.classList.remove('hidden');
            document.getElementById('conflictMsg').textContent = "Slot already booked by another patient.";
        } else {
            alert('Error booking');
        }
    });

    // Edit Modal Logic
    function openEditModal(appt) {
        document.getElementById('editModal').classList.remove('hidden');
        document.getElementById('editApptId').value = appt.id;
        document.getElementById('editPatientName').textContent = appt.patient_name;
        document.getElementById('editVisitType').textContent = appt.visit_type;
        document.getElementById('editDate').textContent = document.getElementById('displayDate').textContent; // Approx
        document.getElementById('editTime').textContent = appt.time;

        document.getElementById('editStatus').value = appt.status;
        document.getElementById('editReason').value = appt.reason || '';
        toggleReasonBox();
    }

    function closeEditModal() {
        document.getElementById('editModal').classList.add('hidden');
    }

    function toggleReasonBox() {
        const status = document.getElementById('editStatus').value;
        const box = document.getElementById('reasonContainer');
        if (status === 'Canceled') {
            box.classList.remove('hidden');
        } else {
            box.classList.add('hidden');
        }
    }

    document.getElementById('editForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('editApptId').value;
        const status = document.getElementById('editStatus').value;
        const reason = document.getElementById('editReason').value;

        const response = await fetch(`/appointments/${id}/status`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status: status, reason: reason })
        });

        if (response.ok) {
            closeEditModal();
            loadAppointments();
        } else {
            const res = await response.json();
            alert(res.error || 'Error updating status');
        }
    });

</script>
{% endblock %}