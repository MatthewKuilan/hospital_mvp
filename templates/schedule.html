{% extends "base.html" %}

{% block content %}
<div class="p-8 bg-gray-50 min-h-screen">

    <!-- Header -->
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold text-gray-800">Provider Schedule</h1>
        <button onclick="openBookingModal()"
            class="bg-teal-700 hover:bg-teal-800 text-white font-bold py-2 px-4 rounded shadow flex items-center">
            <span class="mr-2">+</span> New Appointment
        </button>
    </div>

    <!-- Filters (White Box Style) -->
    <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-100 flex items-center space-x-8 mb-6">
        <div class="w-1/3">
            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Provider</label>
            <select id="staffSelect" onchange="loadAppointments()"
                class="block w-full border border-gray-300 rounded px-3 py-2 text-gray-700 bg-white focus:outline-none focus:ring-1 focus:ring-blue-500">
                {% for s in staff %}
                <option value="{{ s.id }}">{{ s.name }} ({{ s.role }})</option>
                {% endfor %}
            </select>
        </div>
        <div class="w-1/3">
            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Date</label>
            <input type="date" id="dateSelect" onchange="loadAppointments()" value="{{ today }}"
                class="block w-full border border-gray-300 rounded px-3 py-2 text-gray-700 focus:outline-none focus:ring-1 focus:ring-blue-500">
        </div>
        <div class="flex-grow flex justify-end items-center text-gray-500 font-medium">
            <!-- Date navigator mock -->
            <button class="p-2 hover:bg-gray-100 rounded">&lt;</button>
            <span class="mx-2" id="displayDate">Dec 1, 2025</span>
            <button class="p-2 hover:bg-gray-100 rounded">&gt;</button>
        </div>
    </div>

    <!-- Schedule Grid -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-100 divide-y divide-gray-100" id="scheduleGrid">
        <!-- Javascript renders slots here -->
    </div>
</div>

<!-- Booking Modal -->
<div id="bookingModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-40">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <h3 class="text-lg font-bold text-gray-900 mb-4">New Appointment</h3>

        <!-- Red Alert -->
        <div id="conflictAlert" class="hidden bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-4" role="alert">
            <p><strong>Conflict!</strong> <span id="conflictMsg">Time slot unavailable.</span></p>
        </div>

        <form id="bookingForm">
            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2">Patient</label>
                <select id="patientSelect" class="border rounded w-full py-2 px-3 text-gray-700">
                    <!-- Populated via API -->
                </select>
            </div>
            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2">Visit Type</label>
                <select id="visitType" class="border rounded w-full py-2 px-3 text-gray-700">
                    <option value="General Checkup">General Checkup</option>
                    <option value="Consult">Consult</option>
                    <option value="Follow-up">Follow-up</option>
                    <option value="Lab Work">Lab Work</option>
                </select>
            </div>
            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2">Time</label>
                <select id="timeSlot" class="border rounded w-full py-2 px-3 text-gray-700">
                    <!-- 9-5 slots -->
                    <option value="09:00">09:00 AM</option>
                    <option value="10:00">10:00 AM</option>
                    <option value="11:00">11:00 AM</option>
                    <!-- Skip 12 for lunch -->
                    <option value="13:00">01:00 PM</option>
                    <option value="14:00">02:00 PM</option>
                    <option value="15:00">03:00 PM</option>
                    <option value="16:00">04:00 PM</option>
                    <option value="17:00">05:00 PM</option>
                </select>
            </div>
            <div class="flex justify-end gap-2">
                <button type="button" onclick="closeBookingModal()"
                    class="bg-gray-500 text-white px-4 py-2 rounded">Cancel</button>
                <button type="submit" class="bg-teal-700 text-white px-4 py-2 rounded">Book</button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Appointment Modal (Updated) -->
<div id="editModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-0 border w-[500px] shadow-2xl rounded-lg bg-white overflow-hidden">
        <!-- Header -->
        <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center">
            <h3 class="text-xl font-bold text-gray-800">Edit Appointment</h3>
            <button onclick="closeEditModal()"
                class="text-gray-400 hover:text-gray-600 font-bold text-xl">&times;</button>
        </div>

        <div class="p-6">
            <!-- Appointment Info -->
            <div class="flex justify-between items-start mb-6">
                <div>
                    <h4 class="text-lg font-bold text-gray-900" id="editPatientName">Patient Name</h4>
                    <p class="text-sm text-gray-500" id="editVisitType">Visit Type</p>
                </div>
                <div class="text-right text-gray-600 text-sm">
                    <p id="editDate">Nov 3, 2025</p>
                    <p id="editTime">11:00 AM</p>
                </div>
            </div>

            <form id="editForm">
                <input type="hidden" id="editApptId">

                <div class="mb-6">
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Appointment Status</label>
                    <select id="editStatus" onchange="toggleReasonBox()"
                        class="block w-full border-2 border-yellow-400 rounded-md px-4 py-3 text-gray-900 font-bold focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="Scheduled">Scheduled</option>
                        <option value="Completed">Completed</option>
                        <option value="Canceled">Canceled</option>
                    </select>
                </div>

                <!-- Reason Box (Conditional Red) -->
                <div id="reasonContainer" class="hidden mb-6">
                    <label class="block text-xs font-bold text-red-600 uppercase mb-2">Reason for Cancellation *</label>
                    <textarea id="editReason" rows="3"
                        class="block w-full border border-red-200 bg-red-50 rounded-md px-4 py-3 text-gray-900 focus:outline-none focus:border-red-500"
                        placeholder="e.g. Patient requested reschedule"></textarea>
                </div>

                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" onclick="closeEditModal()"
                        class="text-gray-600 font-bold px-4 py-2 hover:text-gray-800">Cancel</button>
                    <button type="submit"
                        class="bg-teal-800 hover:bg-teal-900 text-white font-bold px-6 py-2 rounded-md">Update
                        Status</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        loadPatients();
        loadAppointments();

        // Date display
        const dateInput = document.getElementById('dateSelect');
        const displaySpan = document.getElementById('displayDate');
        displaySpan.textContent = new Date(dateInput.value).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        dateInput.addEventListener('change', (e) => {
            displaySpan.textContent = new Date(e.target.value).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        });
    });

    async function loadPatients() {
        const response = await fetch('/patients/api/search');
        const patients = await response.json();
        const select = document.getElementById('patientSelect');
        patients.forEach(p => {
            const opt = document.createElement('option');
            opt.value = p.id;
            opt.textContent = `${p.name} (CH-${p.chart_number})`;
            select.appendChild(opt);
        });
    }

    async function loadAppointments() {
        const staffId = document.getElementById('staffSelect').value;
        const date = document.getElementById('dateSelect').value;

        const response = await fetch(`/appointments/api/list?staff_id=${staffId}&date=${date}`);
        const appointments = await response.json();

        renderGrid(appointments);
    }

    function renderGrid(appointments) {
        const grid = document.getElementById('scheduleGrid');
        grid.innerHTML = '';

        const times = ['09:00', '10:00', '11:00', '12:00', '13:00', '14:00', '15:00', '16:00', '17:00'];

        times.forEach(time => {
            const row = document.createElement('div');
            row.className = 'flex min-h-[100px] hover:bg-gray-50/50 transition';

            // Time Column
            const timeCol = document.createElement('div');
            timeCol.className = 'w-24 p-4 border-r border-gray-100 text-xs font-bold text-gray-400 uppercase pt-6';

            // Format time AM/PM
            const [h, m] = time.split(':');
            const d = new Date(); d.setHours(h); d.setMinutes(m);
            const timeStr = d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            timeCol.textContent = timeStr;

            row.appendChild(timeCol);

            // Content Column
            const contentCol = document.createElement('div');
            contentCol.className = 'flex-grow p-2 relative';

            // Lunch Break Logic (12:00)
            if (time === '12:00') {
                contentCol.innerHTML = `
                    <div class="h-full w-full bg-gray-50 rounded border border-dashed border-gray-200 flex items-center justify-center text-sm font-bold text-gray-400">
                        Lunch Break
                    </div>
                `;
            } else {
                // Find appointment
                const appt = appointments.find(a => a.time === time);

                if (appt) {
                    if (appt.status === 'Canceled') {
                        // Canceled styling (Strikethrough or dim)
                        contentCol.innerHTML = `
                            <div class="h-full w-full bg-red-50 border border-red-100 rounded p-4 cursor-pointer opacity-75" onclick="openEditModal(${JSON.stringify(appt).replace(/"/g, '&quot;')})">
                                <p class="font-bold text-red-900 line-through">${appt.patient_name}</p>
                                <p class="text-xs text-red-700">Canceled: ${appt.reason || 'No reason'}</p>
                            </div>
                        `;
                    } else if (appt.status === 'Completed') {
                        // Completed styling
                        contentCol.innerHTML = `
                            <div class="h-full w-full bg-green-50 border border-green-100 rounded p-4 cursor-pointer" onclick="openEditModal(${JSON.stringify(appt).replace(/"/g, '&quot;')})">
                                <p class="font-bold text-green-900">${appt.patient_name} âœ“</p>
                                <p class="text-xs text-green-700">${appt.visit_type}</p>
                            </div>
                        `;
                    } else {
                        // Scheduled (Blue Card)
                        contentCol.innerHTML = `
                            <div class="h-full w-full bg-blue-50/80 border-l-4 border-blue-500 rounded-r p-3 cursor-pointer hover:shadow-md transition" onclick="openEditModal(${JSON.stringify(appt).replace(/"/g, '&quot;')})">
                                <div class="flex justify-between">
                                    <p class="font-bold text-blue-900">${appt.patient_name}</p>
                                    <span class="bg-white text-blue-600 text-[10px] font-bold px-2 py-0.5 rounded-full border border-blue-100">Scheduled</span>
                                </div>
                                <p class="text-xs text-blue-700 mt-1">${appt.visit_type}</p>
                                <p class="text-[10px] text-blue-400 mt-2">ðŸ•’ ${timeStr} - ${new Date(d.getTime() + 30 * 60000).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}</p>
                            </div>
                        `;
                    }
                } else {
                    // Empty slot
                }
            }

            row.appendChild(contentCol);
            grid.appendChild(row);
        });
    }

    // Modal Logic
    function openBookingModal() {
        document.getElementById('bookingModal').classList.remove('hidden');
        document.getElementById('conflictAlert').classList.add('hidden');
    }

    function closeBookingModal() {
        document.getElementById('bookingModal').classList.add('hidden');
    }

    document.getElementById('bookingForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const data = {
            staff_id: document.getElementById('staffSelect').value,
            patient_id: document.getElementById('patientSelect').value,
            visit_type: document.getElementById('visitType').value,
            date: document.getElementById('dateSelect').value,
            time: document.getElementById('timeSlot').value
        };

        const response = await fetch('/appointments/create', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        if (response.ok) {
            closeBookingModal();
            loadAppointments();
        } else if (response.status === 409) {
            const conflict = document.getElementById('conflictAlert');
            conflict.classList.remove('hidden');
            document.getElementById('conflictMsg').textContent = "Slot already booked by another patient.";
        } else {
            alert('Error booking');
        }
    });

    // Edit Modal Logic
    function openEditModal(appt) {
        document.getElementById('editModal').classList.remove('hidden');
        document.getElementById('editApptId').value = appt.id;
        document.getElementById('editPatientName').textContent = appt.patient_name;
        document.getElementById('editVisitType').textContent = appt.visit_type;
        document.getElementById('editDate').textContent = document.getElementById('displayDate').textContent; // Approx
        document.getElementById('editTime').textContent = appt.time;

        document.getElementById('editStatus').value = appt.status;
        document.getElementById('editReason').value = appt.reason || '';
        toggleReasonBox();
    }

    function closeEditModal() {
        document.getElementById('editModal').classList.add('hidden');
    }

    function toggleReasonBox() {
        const status = document.getElementById('editStatus').value;
        const box = document.getElementById('reasonContainer');
        if (status === 'Canceled') {
            box.classList.remove('hidden');
        } else {
            box.classList.add('hidden');
        }
    }

    document.getElementById('editForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('editApptId').value;
        const status = document.getElementById('editStatus').value;
        const reason = document.getElementById('editReason').value;

        const response = await fetch(`/appointments/${id}/status`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status: status, reason: reason })
        });

        if (response.ok) {
            closeEditModal();
            loadAppointments();
        } else {
            const res = await response.json();
            alert(res.error || 'Error updating status');
        }
    });

</script>
{% endblock %}