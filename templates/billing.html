{% extends "base.html" %}

{% block content %}
<div class="p-8">

    <!-- Header & Actions -->
    <div class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-3xl font-bold text-gray-800">Billing</h1>
            <p class="text-gray-500">Manage invoices and payments.</p>
        </div>
        <button onclick="openCreateModal()"
            class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded shadow">
            Create Invoice
        </button>
    </div>

    <!-- Advanced Filters -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-100 p-4 mb-6">
        <div class="flex flex-wrap items-center gap-4">
            <!-- Status Filter -->
            <div class="flex items-center gap-2">
                <label class="text-sm font-medium text-gray-600">Status:</label>
                <select id="filterStatus" onchange="applyFilters()"
                    class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-teal-500 focus:outline-none">
                    <option value="">All</option>
                    <option value="OPEN">Open</option>
                    <option value="PARTIAL">Partial</option>
                    <option value="PAID">Paid</option>
                </select>
            </div>

            <!-- Date Range -->
            <div class="flex items-center gap-2">
                <label class="text-sm font-medium text-gray-600">From:</label>
                <input type="date" id="filterDateFrom" onchange="applyFilters()"
                    class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-teal-500 focus:outline-none">
            </div>
            <div class="flex items-center gap-2">
                <label class="text-sm font-medium text-gray-600">To:</label>
                <input type="date" id="filterDateTo" onchange="applyFilters()"
                    class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-teal-500 focus:outline-none">
            </div>

            <!-- Clear Filters -->
            <button onclick="clearFilters()" class="text-sm text-gray-500 hover:text-teal-600 underline">
                Clear Filters
            </button>

            <!-- Results Count -->
            <span id="filterCount" class="ml-auto text-sm text-gray-400"></span>
        </div>
    </div>

    <!-- Invoices Table -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-100 overflow-hidden">
        <table class="min-w-full text-left" id="invoicesTable">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-xs font-semibold text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 select-none"
                        onclick="sortTable(0)" data-sort="asc">
                        Date <span class="sort-icon text-gray-300">‚Üï</span>
                    </th>
                    <th class="px-6 py-3 text-xs font-semibold text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 select-none"
                        onclick="sortTable(1)">
                        Patient <span class="sort-icon text-gray-300">‚Üï</span>
                    </th>
                    <th class="px-6 py-3 text-xs font-semibold text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 select-none"
                        onclick="sortTable(2)">
                        Total <span class="sort-icon text-gray-300">‚Üï</span>
                    </th>
                    <th class="px-6 py-3 text-xs font-semibold text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 select-none"
                        onclick="sortTable(3)">
                        Paid <span class="sort-icon text-gray-300">‚Üï</span>
                    </th>
                    <th class="px-6 py-3 text-xs font-semibold text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 select-none"
                        onclick="sortTable(4)">
                        Balance <span class="sort-icon text-gray-300">‚Üï</span>
                    </th>
                    <th class="px-6 py-3 text-xs font-semibold text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 select-none"
                        onclick="sortTable(5)">
                        Status <span class="sort-icon text-gray-300">‚Üï</span>
                    </th>
                    <th class="px-6 py-3 text-xs font-semibold text-gray-500 uppercase tracking-wider">Actions</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200" id="invoicesBody">
                {% if invoices %}
                {% for inv in invoices %}
                <tr class="hover:bg-gray-50 cursor-pointer invoice-row" onclick="openDetailModal({{ inv.id }})"
                    data-status="{{ inv.status }}" data-date="{{ inv.date_issued }}">
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ inv.date_issued }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ inv.patient.name }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${{ "%.2f"|format(inv.total_amount) }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" id="paid-{{ inv.id }}">${{
                        "%.2f"|format(inv.paid_amount) }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-700" id="balance-{{ inv.id }}">
                        ${{ "%.2f"|format(inv.balance_due) }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <span id="badge-{{ inv.id }}"
                            class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                            {% if inv.status == 'PAID' %} bg-green-100 text-green-800 {% elif inv.status == 'PARTIAL' %} bg-orange-100 text-orange-800 {% else %} bg-blue-100 text-blue-800 {% endif %}">
                            {{ inv.status }}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-blue-600" onclick="event.stopPropagation()">
                        {% if inv.status != 'PAID' %}
                        <button onclick="openPayModal({{ inv.id }})"
                            class="hover:text-blue-900 hover:underline">Pay</button>
                        {% else %}
                        <span class="text-gray-400 cursor-default">Paid</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
                {% else %}
                <tr>
                    <td colspan="7" class="px-6 py-12 text-center">
                        <div class="flex flex-col items-center justify-center">
                            <svg class="w-16 h-16 text-gray-300 mb-4" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                    d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01">
                                </path>
                            </svg>
                            <p class="text-gray-500 font-medium text-lg mb-1">No invoices yet</p>
                            <p class="text-gray-400 text-sm">Create your first invoice to get started</p>
                        </div>
                    </td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>

</div>

<!-- Create Invoice Modal -->
<div id="createModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-10 mx-auto p-0 border w-2/3 shadow-2xl rounded-lg bg-white overflow-hidden">
        <!-- Header -->
        <div class="px-8 py-5 border-b border-gray-200 flex justify-between items-center bg-gray-50">
            <h3 class="text-xl font-bold text-gray-800">New Invoice</h3>
            <span class="bg-gray-200 text-gray-600 text-xs font-bold px-2 py-1 rounded">DRAFT</span>
        </div>

        <div class="p-8 max-h-[70vh] overflow-y-auto">
            <div class="grid grid-cols-2 gap-8 mb-8">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Patient</label>
                    <select id="invoicePatient"
                        class="block w-full bg-yellow-50 border border-gray-300 rounded px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <!-- Populated via API -->
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Invoice Date</label>
                    <input type="date" id="invoiceDate" value="{{ today }}"
                        class="block w-full border border-gray-300 rounded px-4 py-3">
                </div>
            </div>

            <!-- Line Items -->
            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-4">Line Items</label>
                <table class="w-full mb-4">
                    <thead>
                        <tr class="bg-gray-50 text-left">
                            <th class="p-3 text-xs font-bold text-gray-500 uppercase">Description</th>
                            <th class="p-3 text-xs font-bold text-gray-500 uppercase w-20">Qty</th>
                            <th class="p-3 text-xs font-bold text-gray-500 uppercase w-32">Unit Price</th>
                            <th class="p-3 text-xs font-bold text-gray-500 uppercase w-32 text-right">Total</th>
                            <th class="p-3 w-10"></th>
                        </tr>
                    </thead>
                    <tbody id="lineItemsBody">
                        <!-- Rows goes here -->
                    </tbody>
                </table>
                <button type="button" onclick="addItemRow()"
                    class="text-teal-600 font-bold text-sm flex items-center hover:text-teal-800">
                    <span class="mr-1">+</span> Add Item
                </button>
            </div>

            <div class="flex justify-end mt-8 border-t pt-4">
                <div class="text-right">
                    <p class="text-gray-500 text-sm">Estimated Total</p>
                    <p class="text-2xl font-bold text-gray-800" id="createTotalDisplay">$0.00</p>
                </div>
            </div>

        </div>

        <!-- Footer -->
        <div class="px-8 py-5 border-t border-gray-200 bg-gray-50 flex justify-end space-x-3">
            <button onclick="closeCreateModal()"
                class="text-gray-600 hover:text-gray-800 font-bold px-4 py-2">Cancel</button>
            <button onclick="submitInvoice()"
                class="bg-teal-700 hover:bg-teal-800 text-white font-bold px-6 py-2 rounded shadow">Save
                Invoice</button>
        </div>
    </div>
</div>

<!-- Invoice Detail Modal -->
<div id="detailModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-10 mx-auto p-0 border w-2/3 shadow-2xl rounded-lg bg-white overflow-hidden">

        <div class="p-8" id="detailContent">
            <!-- Content populated by JS -->
            <div class="flex justify-between items-start mb-8">
                <div>
                    <div class="flex items-center gap-2">
                        <div class="p-2 bg-gray-100 rounded">üìÑ</div>
                        <h1 class="text-2xl font-bold text-gray-900" id="detailTitle">Invoice #INV-???</h1>
                    </div>
                    <p class="text-gray-500 mt-1" id="detailDate">Issued: ...</p>
                </div>
                <div id="detailStatusBadge">
                    <!-- Badge -->
                </div>
            </div>

            <div class="flex justify-between mb-10">
                <div>
                    <p class="text-xs font-bold text-gray-500 uppercase mb-1">Bill To</p>
                    <p class="font-bold text-lg text-gray-900" id="detailPatientName">...</p>
                    <p class="text-gray-500" id="detailPatientChart">Chart #...</p>
                </div>
                <div class="text-right">
                    <p class="text-xs font-bold text-gray-500 uppercase mb-1">Provider</p>
                    <p class="font-bold text-gray-900">Dr. Rivera</p> <!-- Mocked for now -->
                    <p class="text-gray-500">General Practice</p>
                </div>
            </div>

            <table class="w-full mb-8">
                <thead>
                    <tr class="border-b border-gray-200">
                        <th class="py-3 text-left text-sm font-bold text-gray-600">Description</th>
                        <th class="py-3 text-center text-sm font-bold text-gray-600">Qty</th>
                        <th class="py-3 text-right text-sm font-bold text-gray-600">Unit Price</th>
                        <th class="py-3 text-right text-sm font-bold text-gray-600">Amount</th>
                    </tr>
                </thead>
                <tbody id="detailItemsBody" class="divide-y divide-gray-100">
                    <!-- Items -->
                </tbody>
            </table>

            <div class="flex justify-end">
                <div class="w-64">
                    <div class="flex justify-between py-2 text-gray-600">
                        <span>Subtotal</span>
                        <span id="detailSubtotal">$0.00</span>
                    </div>
                    <div class="flex justify-between py-2 text-gray-600 border-b border-gray-200 mb-2">
                        <span>Tax (0%)</span>
                        <span>$0.00</span>
                    </div>
                    <div class="flex justify-between py-2 text-xl font-bold text-teal-800">
                        <span>Total Due</span>
                        <span id="detailTotal">$0.00</span>
                    </div>
                </div>
            </div>

            <!-- Payment History Section -->
            <div id="paymentHistorySection" class="mt-8 pt-6 border-t border-gray-200">
                <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Payment History
                </h3>
                <div id="paymentHistoryList" class="space-y-2">
                    <!-- Populated by JS -->
                </div>
                <p id="noPaymentsMessage" class="hidden text-gray-400 text-sm italic">No payments recorded yet.</p>
            </div>
        </div>

        <div class="px-8 py-5 border-t border-gray-200 bg-gray-50 flex justify-between">
            <button onclick="exportPDF()"
                class="bg-white border border-gray-300 text-gray-700 font-bold px-4 py-2 rounded flex items-center gap-2 hover:bg-gray-100">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                    </path>
                </svg>
                Export PDF
            </button>
            <div class="flex gap-3">
                <button onclick="window.print()"
                    class="bg-white border border-gray-300 text-gray-700 font-bold px-4 py-2 rounded">
                    Print
                </button>
                <button onclick="closeDetailModal()" class="bg-gray-800 text-white font-bold px-6 py-2 rounded">
                    Close
                </button>
            </div>
        </div>

    </div>
</div>

<!-- Pay Modal (Reuse) -->
<div id="payModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-6 border w-[420px] shadow-lg rounded-lg bg-white">
        <h3 class="text-lg font-bold text-gray-900 mb-4">Record Payment</h3>
        <form id="payForm">
            <input type="hidden" id="payInvoiceId">
            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2">Payment Amount</label>
                <div class="relative">
                    <span class="absolute left-3 top-2 text-gray-500">$</span>
                    <input type="number" id="payAmount" step="0.01" placeholder="0.00"
                        class="border rounded w-full py-2 pl-7 pr-3 text-gray-700 focus:ring-2 focus:ring-green-500 focus:outline-none">
                </div>
            </div>
            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2">Payment Method</label>
                <select id="payMethod"
                    class="border rounded w-full py-2 px-3 text-gray-700 focus:ring-2 focus:ring-green-500 focus:outline-none">
                    <option value="Cash">Cash</option>
                    <option value="Credit Card">Credit Card</option>
                    <option value="Debit Card">Debit Card</option>
                    <option value="Insurance">Insurance</option>
                    <option value="Check">Check</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2">Reference <span
                        class="font-normal text-gray-400">(optional)</span></label>
                <input type="text" id="payReference" placeholder="Transaction ID, check number, etc."
                    class="border rounded w-full py-2 px-3 text-gray-700 focus:ring-2 focus:ring-green-500 focus:outline-none">
            </div>
            <div class="flex justify-end gap-2 pt-2">
                <button type="button" onclick="closePayModal()"
                    class="bg-gray-200 text-gray-700 font-medium px-4 py-2 rounded hover:bg-gray-300">Cancel</button>
                <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold px-6 py-2 rounded">
                    Record Payment
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', loadPatients);

    async function loadPatients() {
        const response = await fetch('/patients/api/search');
        const patients = await response.json();
        const select = document.getElementById('invoicePatient');
        patients.forEach(p => {
            const opt = document.createElement('option');
            opt.value = p.id;
            opt.textContent = `${p.name} (CH-${p.chart_number})`;
            select.appendChild(opt);
        });

        // Add one default row
        addItemRow();
    }

    // --- Create Invoice Logic ---
    function openCreateModal() {
        document.getElementById('createModal').classList.remove('hidden');
    }

    function closeCreateModal() {
        document.getElementById('createModal').classList.add('hidden');
    }

    function addItemRow() {
        const tbody = document.getElementById('lineItemsBody');
        const tr = document.createElement('tr');
        tr.className = "bg-yellow-50/20"; // slight tint
        tr.innerHTML = `
            <td class="p-2"><input type="text" class="w-full border-gray-300 rounded p-2 text-sm font-bold text-gray-700 bg-transparent" placeholder="Item Name" name="desc"></td>
            <td class="p-2"><input type="number" class="w-full border-gray-300 rounded p-2 text-sm text-center" value="1" min="1" name="qty" onchange="calcTotal()"></td>
            <td class="p-2"><input type="number" class="w-full border-gray-300 rounded p-2 text-sm text-right" value="0.00" min="0" step="0.01" name="price" onchange="calcTotal()"></td>
            <td class="p-2 text-right font-bold text-gray-800 row-total">$0.00</td>
            <td class="p-2 text-center text-gray-400 cursor-pointer hover:text-red-500" onclick="this.closest('tr').remove(); calcTotal()">üóë</td>
        `;
        tbody.appendChild(tr);
    }

    function calcTotal() {
        let total = 0;
        const rows = document.querySelectorAll('#lineItemsBody tr');
        rows.forEach(row => {
            const qty = parseFloat(row.querySelector('[name="qty"]').value) || 0;
            const price = parseFloat(row.querySelector('[name="price"]').value) || 0;
            const rowTotal = qty * price;
            total += rowTotal;
            row.querySelector('.row-total').textContent = '$' + rowTotal.toFixed(2);
        });
        document.getElementById('createTotalDisplay').textContent = '$' + total.toFixed(2);
    }

    async function submitInvoice() {
        const patientId = document.getElementById('invoicePatient').value;
        const date = document.getElementById('invoiceDate').value;

        const items = [];
        document.querySelectorAll('#lineItemsBody tr').forEach(row => {
            items.push({
                description: row.querySelector('[name="desc"]').value,
                qty: row.querySelector('[name="qty"]').value,
                unit_price: row.querySelector('[name="price"]').value
            });
        });

        if (items.length === 0) {
            alert("Add at least one item");
            return;
        }

        const response = await fetch('/invoices/create', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ patient_id: patientId, date: date, items: items })
        });

        if (response.ok) {
            window.location.reload();
        } else {
            alert('Error creating invoice');
        }
    }

    // --- Detail Modal Logic ---
    let currentInvoiceId = null;

    async function openDetailModal(id) {
        currentInvoiceId = id;
        const response = await fetch(`/invoices/${id}/details`);
        const data = await response.json();

        const m = document.getElementById('detailModal');
        document.getElementById('detailTitle').textContent = `Invoice #INV-${1000 + data.id}`;
        document.getElementById('detailDate').textContent = `Issued: ${data.date}`;
        document.getElementById('detailPatientName').textContent = data.patient_name;
        document.getElementById('detailPatientChart').textContent = `Chart #${data.patient_chart}`;

        // Badge
        let badgeClass = "bg-blue-100 text-blue-800";
        if (data.status === 'PAID') badgeClass = "bg-green-100 text-green-800";
        else if (data.status === 'PARTIAL') badgeClass = "bg-orange-100 text-orange-800";

        document.getElementById('detailStatusBadge').innerHTML = `
            <span class="px-3 py-1 rounded-full text-sm font-bold ${badgeClass} uppercase tracking-wide">
                ${data.status}
            </span>
        `;

        // Items
        const tbody = document.getElementById('detailItemsBody');
        tbody.innerHTML = '';
        data.items.forEach(item => {
            tbody.innerHTML += `
                <tr>
                    <td class="py-3 text-left text-gray-900 font-medium">${item.description}</td>
                    <td class="py-3 text-center text-gray-600">${item.qty}</td>
                    <td class="py-3 text-right text-gray-600">$${item.unit_price.toFixed(2)}</td>
                    <td class="py-3 text-right text-gray-900 font-bold">$${item.total.toFixed(2)}</td>
                </tr>
            `;
        });

        document.getElementById('detailSubtotal').textContent = '$' + data.total.toFixed(2);
        document.getElementById('detailTotal').textContent = '$' + data.balance.toFixed(2);

        // Payment History
        const paymentList = document.getElementById('paymentHistoryList');
        const noPayments = document.getElementById('noPaymentsMessage');
        paymentList.innerHTML = '';

        if (data.payments && data.payments.length > 0) {
            noPayments.classList.add('hidden');
            data.payments.forEach(p => {
                const methodIcon = getPaymentMethodIcon(p.method);
                paymentList.innerHTML += `
                    <div class="flex items-center justify-between p-3 bg-green-50 rounded-lg border border-green-100">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-green-100 flex items-center justify-center text-green-600">
                                ${methodIcon}
                            </div>
                            <div>
                                <p class="font-bold text-green-800">$${p.amount.toFixed(2)}</p>
                                <p class="text-xs text-green-600">${p.method}${p.reference ? ' ‚Ä¢ ' + p.reference : ''}</p>
                            </div>
                        </div>
                        <span class="text-xs text-gray-500">${p.date}</span>
                    </div>
                `;
            });
        } else {
            noPayments.classList.remove('hidden');
        }

        m.classList.remove('hidden');
    }

    function getPaymentMethodIcon(method) {
        const icons = {
            'Cash': 'üíµ',
            'Credit Card': 'üí≥',
            'Debit Card': 'üí≥',
            'Insurance': 'üè•',
            'Check': 'üìù',
            'Other': 'üí∞'
        };
        return icons[method] || 'üí∞';
    }

    function closeDetailModal() {
        document.getElementById('detailModal').classList.add('hidden');
    }

    // PDF Export
    function exportPDF() {
        // Using browser print with special styling
        const printContent = document.getElementById('detailContent').innerHTML;
        const invoiceNum = document.getElementById('detailTitle').textContent;

        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
                <title>${invoiceNum}</title>
                <style>
                    body { font-family: Arial, sans-serif; padding: 40px; max-width: 800px; margin: 0 auto; }
                    h1 { color: #0d9488; }
                    table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                    th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e5e7eb; }
                    th { font-weight: bold; color: #4b5563; }
                    .text-right { text-align: right; }
                    .text-center { text-align: center; }
                    .font-bold { font-weight: bold; }
                    #paymentHistorySection { margin-top: 30px; padding-top: 20px; border-top: 2px solid #e5e7eb; }
                    @media print { body { padding: 20px; } }
                </style>
            </head>
            <body>
                <h1>MediCore Hospital</h1>
                ${printContent}
            </body>
            </html>
        `);
        printWindow.document.close();
        printWindow.print();
    }

    // --- Pay Modal Logic ---
    function openPayModal(id) {
        document.getElementById('payInvoiceId').value = id;
        document.getElementById('payModal').classList.remove('hidden');
        document.getElementById('payAmount').value = '';
        document.getElementById('payMethod').value = 'Cash';
        document.getElementById('payReference').value = '';
        document.getElementById('payAmount').focus();
    }
    function closePayModal() {
        document.getElementById('payModal').classList.add('hidden');
    }

    document.getElementById('payForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('payInvoiceId').value;
        const amount = document.getElementById('payAmount').value;
        const payment_method = document.getElementById('payMethod').value;
        const reference = document.getElementById('payReference').value;

        const response = await fetch(`/invoices/${id}/pay`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ amount, payment_method, reference })
        });

        const result = await response.json();

        if (response.ok) {
            closePayModal();
            // Reload to sync everything
            window.location.reload();
        } else {
            alert(result.error);
        }
    });

    // --- Filter Functions ---
    function applyFilters() {
        const status = document.getElementById('filterStatus').value;
        const dateFrom = document.getElementById('filterDateFrom').value;
        const dateTo = document.getElementById('filterDateTo').value;

        const rows = document.querySelectorAll('.invoice-row');
        let visibleCount = 0;

        rows.forEach(row => {
            const rowStatus = row.dataset.status;
            const rowDate = row.dataset.date;

            let show = true;

            // Status filter
            if (status && rowStatus !== status) {
                show = false;
            }

            // Date range filter
            if (dateFrom && rowDate < dateFrom) {
                show = false;
            }
            if (dateTo && rowDate > dateTo) {
                show = false;
            }

            row.style.display = show ? '' : 'none';
            if (show) visibleCount++;
        });

        // Update count
        document.getElementById('filterCount').textContent = `Showing ${visibleCount} of ${rows.length} invoices`;
    }

    function clearFilters() {
        document.getElementById('filterStatus').value = '';
        document.getElementById('filterDateFrom').value = '';
        document.getElementById('filterDateTo').value = '';

        const rows = document.querySelectorAll('.invoice-row');
        rows.forEach(row => row.style.display = '');
        document.getElementById('filterCount').textContent = '';
    }

    // --- Sortable Table ---
    let sortDirection = {};

    function sortTable(columnIndex) {
        const table = document.getElementById('invoicesTable');
        const tbody = document.getElementById('invoicesBody');
        const rows = Array.from(tbody.querySelectorAll('.invoice-row'));
        const headers = table.querySelectorAll('thead th');

        // Toggle direction
        sortDirection[columnIndex] = sortDirection[columnIndex] === 'asc' ? 'desc' : 'asc';
        const dir = sortDirection[columnIndex];

        // Update icons
        headers.forEach((th, i) => {
            const icon = th.querySelector('.sort-icon');
            if (icon) {
                if (i === columnIndex) {
                    icon.textContent = dir === 'asc' ? '‚Üë' : '‚Üì';
                    icon.classList.remove('text-gray-300');
                    icon.classList.add('text-teal-600');
                } else {
                    icon.textContent = '‚Üï';
                    icon.classList.remove('text-teal-600');
                    icon.classList.add('text-gray-300');
                }
            }
        });

        // Sort rows
        rows.sort((a, b) => {
            let aVal = a.cells[columnIndex].textContent.trim();
            let bVal = b.cells[columnIndex].textContent.trim();

            // Handle currency values
            if (aVal.startsWith('$')) {
                aVal = parseFloat(aVal.replace('$', '').replace(',', ''));
                bVal = parseFloat(bVal.replace('$', '').replace(',', ''));
            }

            // Compare
            if (aVal < bVal) return dir === 'asc' ? -1 : 1;
            if (aVal > bVal) return dir === 'asc' ? 1 : -1;
            return 0;
        });

        // Re-append rows
        rows.forEach(row => tbody.appendChild(row));
    }

</script>
{% endblock %}